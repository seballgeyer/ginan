name: Build GUI macOS
on:
  push:
    branches: [main, develop, develop-weekly]
  pull_request:
    branches: [main, develop, develop-weekly]
  workflow_dispatch:
env:
  PYTHON_VERSION: "3.12.7" # pinned Python (change if you need another)
  PYSIDE_VERSION: "6.6.3.1" # pinned PySide6 (recommended to pin)
  PIP_CACHE_KEY: "pip-cache-v1"
jobs:
  build-gui-macos-arm64:
    name: Build macOS (arm64)
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Download macOS arm64 native binaries
        uses: dawidd6/action-download-artifact@v3
        with:
          name: ginan-macos-arm64
          path: bin/
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: build-macos.yml
          workflow_conclusion: success
          if_no_artifact_found: fail
      - name: Install Homebrew deps & pyenv
        run: |
          set -e
          brew update
          brew install pyenv
          # optional dependencies that help Python build on older macOS/CI
          brew install openssl readline sqlite3 xz zlib tcl-tk
      - name: Install Python via pyenv
        shell: bash
        run: |
          set -e
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          if ! command -v pyenv >/dev/null 2>&1; then
            echo "pyenv not found after brew install"
            exit 1
          fi
          pyenv install -s $PYTHON_VERSION
          pyenv global $PYTHON_VERSION
          # Ensure shims on PATH for remainder of job steps
          eval "$(pyenv init -)"
          python --version
          python -m pip install --upgrade pip setuptools wheel
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.pyenv/versions/${{ env.PYTHON_VERSION }}/lib/python*/site-packages
          key: ${{ runner.os }}-pip-${{ env.PIP_CACHE_KEY }}-${{ hashFiles('scripts/GinanUI/requirements.txt') }}
      - name: Install Python dependencies
        run: |
          set -e
          eval "$(pyenv init -)"
          python -m pip install --upgrade pip
          # ensure a pinned PySide6 consistent across builds (optional if in requirements.txt)
          python -m pip install "PySide6==${PYSIDE_VERSION}"
          # install the rest - use requirements.txt if present
          if [ -f scripts/GinanUI/requirements.txt ]; then
            python -m pip install -r scripts/GinanUI/requirements.txt
          fi
          # pyinstaller
          python -m pip install pyinstaller
      - name: Convert UI files to Python
        working-directory: scripts/GinanUI
        run: |
          set -e
          eval "$(pyenv init -)"
          pyside6-uic app/views/main_window.ui -o app/views/main_window_ui.py
          # Fix import path in generated file if needed
          sed -i '' '23s/.*/from scripts.GinanUI.app.resources import ginan_logo_rc/' app/views/main_window_ui.py || true
      - name: Make binaries executable
        run: chmod +x bin/* || true
      - name: Build GUI with PyInstaller (.app)
        run: |
          set -e
          eval "$(pyenv init -)"
          # Use pyinstaller clean build; use --onedir (default) -> produces dist/GinanUI.app
          python -m PyInstaller --clean --noconfirm \
            --name GinanUI \
            --windowed \
            --strip \
            --add-data "scripts/GinanUI/app:app" \
            --add-data "scripts/plot_pos.py:scripts" \
            --add-binary "bin/*:bin" \
            --hidden-import=PySide6 \
            --hidden-import=PySide6.QtWebEngineWidgets \
            --hidden-import=PySide6.QtWebEngineCore \
            --hidden-import=plotly \
            --hidden-import=scripts.plot_pos \
            --hidden-import=scripts.GinanUI.app \
            --hidden-import=scripts.GinanUI.app.models \
            --hidden-import=scripts.GinanUI.app.models.execution \
            --hidden-import=scripts.GinanUI.app.controllers \
            --hidden-import=scripts.GinanUI.app.controllers.input_controller \
            --hidden-import=scripts.GinanUI.app.controllers.visualisation_controller \
            --hidden-import=scripts.GinanUI.app.utils \
            --hidden-import=scripts.GinanUI.app.utils.workers \
            --hidden-import=scripts.GinanUI.app.utils.cddis_credentials \
            --hidden-import=scripts.GinanUI.app.utils.cddis_email \
            --hidden-import=scripts.GinanUI.app.utils.common_dirs \
            --hidden-import=scripts.GinanUI.app.utils.gn_functions \
            --hidden-import=scripts.GinanUI.app.utils.yaml \
            --hidden-import=scripts.GinanUI.app.views.main_window_ui \
            --collect-all scripts.GinanUI \
            scripts/GinanUI/main.py
      - name: Bundle QtWebEngine helper and resources (arm64)
        run: |
          set -e
          APP="dist/GinanUI.app"
          INTERNAL_QT="dist/GinanUI/_internal/PySide6/Qt"
          if [ -d "$INTERNAL_QT" ]; then
            QT_DIR="$INTERNAL_QT"
          else
              QT_DIR=$(python - <<'PY'
              import os
              try:
                import PySide6
                print(os.path.join(os.path.dirname(PySide6.__file__), 'Qt'))
              except Exception:
                print('')
              PY
              )
            if [ -z "$QT_DIR" ] || [ ! -d "$QT_DIR" ]; then
              echo "PySide6 Qt directory not found in _internal or site-packages";
              QT_DIR=""
            fi
          fi
          mkdir -p "$APP/Contents/Helpers"
          if [ -d "$QT_DIR/libexec/QtWebEngineProcess.app" ]; then
            cp -R "$QT_DIR/libexec/QtWebEngineProcess.app" "$APP/Contents/Helpers/"
          elif [ -d "$QT_DIR/lib/QtWebEngineCore.framework/Helpers/QtWebEngineProcess.app" ]; then
            cp -R "$QT_DIR/lib/QtWebEngineCore.framework/Helpers/QtWebEngineProcess.app" "$APP/Contents/Helpers/"
          fi
          mkdir -p "$APP/Contents/Resources"
          RES1="$QT_DIR/resources"
          RES2="$QT_DIR/lib/QtWebEngineCore.framework/Resources"
          if [ -d "$RES2" ]; then
            cp -R "$RES2"/*.pak "$APP/Contents/Resources"/ || true
            cp -R "$RES2"/*.dat "$APP/Contents/Resources"/ || true
            [ -f "$RES2/v8_context_snapshot.bin" ] && cp "$RES2/v8_context_snapshot.bin" "$APP/Contents/Resources"/ || true
            [ -f "$RES2/snapshot_blob.bin" ] && cp "$RES2/snapshot_blob.bin" "$APP/Contents/Resources"/ || true
            if [ -d "$RES2/qtwebengine_locales" ]; then
              rm -rf "$APP/Contents/Resources/qtwebengine_locales" || true
              cp -R "$RES2/qtwebengine_locales" "$APP/Contents/Resources"/
            fi
          fi
          if [ -d "$RES1" ]; then
            cp -R "$RES1"/*.pak "$APP/Contents/Resources"/ 2>/dev/null || true
            cp -R "$RES1"/*.dat "$APP/Contents/Resources"/ 2>/dev/null || true
            [ -f "$RES1/v8_context_snapshot.bin" ] && cp "$RES1/v8_context_snapshot.bin" "$APP/Contents/Resources"/ || true
            [ -f "$RES1/snapshot_blob.bin" ] && cp "$RES1/snapshot_blob.bin" "$APP/Contents/Resources"/ || true
            if [ -d "$RES1/qtwebengine_locales" ]; then
              rm -rf "$APP/Contents/Resources/qtwebengine_locales" || true
              cp -R "$RES1/qtwebengine_locales" "$APP/Contents/Resources"/
            fi
          fi
          # Add rpath to helper for bundled Qt frameworks (best-effort)
          HELPER="$APP/Contents/Helpers/QtWebEngineProcess.app/Contents/MacOS/QtWebEngineProcess"
          if [ -f "$HELPER" ]; then
            install_name_tool -add_rpath "@executable_path/../../Frameworks" "$HELPER" || true
          fi
          # small launcher script
          cat > "$APP/Contents/MacOS/run.sh" << 'EOF'
          #!/usr/bin/env zsh
          HERE="$(cd "$(dirname "$0")" && pwd)"
          export QTWEBENGINEPROCESS_PATH="$HERE/../Helpers/QtWebEngineProcess.app/Contents/MacOS/QtWebEngineProcess"
          export QTWEBENGINE_RESOURCES_PATH="$HERE/../Resources"
          export QTWEBENGINE_LOCALES_PATH="$HERE/../Resources/qtwebengine_locales"
          export QTWEBENGINE_DISABLE_SANDBOX=1
          export QTWEBENGINE_CHROMIUM_FLAGS="--no-sandbox --disable-gpu-sandbox --disable-seccomp-filter-sandbox --disable-logging --log-level=3"
          export QT_LOGGING_RULES="qt.webengine.*=false"
          exec "$HERE/GinanUI"
          EOF
          chmod +x "$APP/Contents/MacOS/run.sh" || true
          echo "--- Size breakdown (arm64) ---"
          du -sh "$APP" || true
          du -sh "$APP/Contents/Frameworks" || true
          du -sh "$APP/Contents/Resources" || true
          du -sh "$APP/Contents/MacOS" || true
      - name: Strip dSYM and reduce size
        run: |
          set -e
          # Remove debug symbol bundles which are very large and not needed for distribution
          find dist -type d -name "*.dSYM" -prune -exec rm -rf {} + || true
          # Remove leftover .pyc or __pycache__
          find dist -type f -name "*.pyc" -delete || true
          find dist -type d -name "__pycache__" -prune -exec rm -rf {} + || true
      - name: Upload GUI artifact (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: ginan-gui-macos-arm64
          path: dist/GinanUI/
          retention-days: 30
          overwrite: true
  build-gui-macos-x64:
    name: Build macOS (x64)
    runs-on: macos-15-intel
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Download macOS x64 native binaries
        uses: dawidd6/action-download-artifact@v3
        with:
          name: ginan-macos-x64
          path: bin/
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: build-macos.yml
          workflow_conclusion: success
          if_no_artifact_found: fail
      - name: Install Homebrew deps & pyenv
        run: |
          set -e
          brew update
          brew install pyenv
          brew install openssl readline sqlite3 xz zlib tcl-tk
      - name: Install Python via pyenv
        shell: bash
        run: |
          set -e
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          pyenv install -s $PYTHON_VERSION
          pyenv global $PYTHON_VERSION
          eval "$(pyenv init -)"
          python --version
          python -m pip install --upgrade pip setuptools wheel
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.pyenv/versions/${{ env.PYTHON_VERSION }}/lib/python*/site-packages
          key: ${{ runner.os }}-pip-${{ env.PIP_CACHE_KEY }}-${{ hashFiles('scripts/GinanUI/requirements.txt') }}
      - name: Install Python dependencies
        run: |
          set -e
          eval "$(pyenv init -)"
          python -m pip install --upgrade pip
          python -m pip install "PySide6==${PYSIDE_VERSION}"
          if [ -f scripts/GinanUI/requirements.txt ]; then
            python -m pip install -r scripts/GinanUI/requirements.txt
          fi
          python -m pip install pyinstaller
      - name: Convert UI files to Python
        working-directory: scripts/GinanUI
        run: |
          set -e
          eval "$(pyenv init -)"
          pyside6-uic app/views/main_window.ui -o app/views/main_window_ui.py
          sed -i '' '23s/.*/from scripts.GinanUI.app.resources import ginan_logo_rc/' app/views/main_window_ui.py || true
      - name: Make binaries executable
        run: chmod +x bin/* || true
      - name: Build GUI with PyInstaller (.app)
        run: |
          set -e
          eval "$(pyenv init -)"
          python -m PyInstaller --clean --noconfirm \
            --name GinanUI \
            --windowed \
            --strip \
            --add-data "scripts/GinanUI/app:app" \
            --add-data "scripts/plot_pos.py:scripts" \
            --add-binary "bin/*:bin" \
            --hidden-import=PySide6 \
            --hidden-import=PySide6.QtWebEngineWidgets \
            --hidden-import=PySide6.QtWebEngineCore \
            --hidden-import=plotly \
            --hidden-import=scripts.plot_pos \
            --hidden-import=scripts.GinanUI.app \
            --hidden-import=scripts.GinanUI.app.models \
            --hidden-import=scripts.GinanUI.app.models.execution \
            --hidden-import=scripts.GinanUI.app.controllers \
            --hidden-import=scripts.GinanUI.app.controllers.input_controller \
            --hidden-import=scripts.GinanUI.app.controllers.visualisation_controller \
            --hidden-import=scripts.GinanUI.app.utils \
            --hidden-import=scripts.GinanUI.app.utils.workers \
            --hidden-import=scripts.GinanUI.app.utils.cddis_credentials \
            --hidden-import=scripts.GinanUI.app.utils.cddis_email \
            --hidden-import=scripts.GinanUI.app.utils.common_dirs \
            --hidden-import=scripts.GinanUI.app.utils.gn_functions \
            --hidden-import=scripts.GinanUI.app.utils.yaml \
            --hidden-import=scripts.GinanUI.app.views.main_window_ui \
            --collect-all scripts.GinanUI \
            scripts/GinanUI/main.py
      - name: Bundle QtWebEngine helper and resources (x64)
        run: |
          set -e
          APP="dist/GinanUI.app"
          INTERNAL_QT="dist/GinanUI/_internal/PySide6/Qt"
          if [ -d "$INTERNAL_QT" ]; then
            QT_DIR="$INTERNAL_QT"
          else
              QT_DIR=$(python - <<'PY'
              import os
              try:
                import PySide6
                print(os.path.join(os.path.dirname(PySide6.__file__), 'Qt'))
              except Exception:
                print('')
              PY
              )
            if [ -z "$QT_DIR" ] || [ ! -d "$QT_DIR" ]; then
              echo "PySide6 Qt directory not found in _internal or site-packages";
              QT_DIR=""
            fi
          fi
          mkdir -p "$APP/Contents/Helpers"
          if [ -d "$QT_DIR/libexec/QtWebEngineProcess.app" ]; then
            cp -R "$QT_DIR/libexec/QtWebEngineProcess.app" "$APP/Contents/Helpers/"
          elif [ -d "$QT_DIR/lib/QtWebEngineCore.framework/Helpers/QtWebEngineProcess.app" ]; then
            cp -R "$QT_DIR/lib/QtWebEngineCore.framework/Helpers/QtWebEngineProcess.app" "$APP/Contents/Helpers/"
          fi
          mkdir -p "$APP/Contents/Resources"
          RES1="$QT_DIR/resources"
          RES2="$QT_DIR/lib/QtWebEngineCore.framework/Resources"
          if [ -d "$RES1" ]; then
            if ! ls "$APP/Contents/Resources"/qtwebengine_resources*.pak >/dev/null 2>&1; then
              cp -R "$RES1"/* "$APP/Contents/Resources"/ || true
            fi
          fi
          if [ -d "$RES2" ]; then
            if ! ls "$APP/Contents/Resources"/qtwebengine_resources*.pak >/dev/null 2>&1; then
              cp -R "$RES2"/*.pak "$APP/Contents/Resources"/ || true
              cp -R "$RES2"/*.dat "$APP/Contents/Resources"/ || true
              [ -f "$RES2/v8_context_snapshot.bin" ] && cp "$RES2/v8_context_snapshot.bin" "$APP/Contents/Resources"/ || true
              [ -f "$RES2/snapshot_blob.bin" ] && cp "$RES2/snapshot_blob.bin" "$APP/Contents/Resources"/ || true
              if [ -d "$RES2/qtwebengine_locales" ]; then
                cp -R "$RES2/qtwebengine_locales" "$APP/Contents/Resources"/
              fi
            fi
          fi
          HELPER="$APP/Contents/Helpers/QtWebEngineProcess.app/Contents/MacOS/QtWebEngineProcess"
          if [ -f "$HELPER" ]; then
            install_name_tool -add_rpath "@executable_path/../../Frameworks" "$HELPER" || true
          fi
          cat > "$APP/Contents/MacOS/run.sh" << 'EOF'
          #!/usr/bin/env zsh
          HERE="$(cd "$(dirname "$0")" && pwd)"
          export QTWEBENGINEPROCESS_PATH="$HERE/../Helpers/QtWebEngineProcess.app/Contents/MacOS/QtWebEngineProcess"
          export QTWEBENGINE_RESOURCES_PATH="$HERE/../Resources"
          export QTWEBENGINE_LOCALES_PATH="$HERE/../Resources/qtwebengine_locales"
          export QTWEBENGINE_DISABLE_SANDBOX=1
          export QTWEBENGINE_CHROMIUM_FLAGS="--no-sandbox --disable-gpu-sandbox --disable-seccomp-filter-sandbox --disable-logging --log-level=3"
          export QT_LOGGING_RULES="qt.webengine.*=false"
          exec "$HERE/GinanUI"
          EOF
          chmod +x "$APP/Contents/MacOS/run.sh" || true
          echo "--- Size breakdown (x64) ---"
          du -sh "$APP" || true
          du -sh "$APP/Contents/Frameworks" || true
          du -sh "$APP/Contents/Resources" || true
          du -sh "$APP/Contents/MacOS" || true
      - name: Strip dSYM and reduce size
        run: |
          set -e
          find dist -type d -name "*.dSYM" -prune -exec rm -rf {} + || true
          find dist -type f -name "*.pyc" -delete || true
          find dist -type d -name "__pycache__" -prune -exec rm -rf {} + || true
      - name: Upload GUI artifact (x64)
        uses: actions/upload-artifact@v4
        with:
          name: ginan-gui-macos-x64
          path: dist/GinanUI/
          retention-days: 30
          overwrite: true
