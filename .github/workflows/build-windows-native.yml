name: Build Windows (Native)

on:
  push:
    branches: [ main, develop, develop-weekly ]
  pull_request:
    branches: [ main, develop, develop-weekly ]
  workflow_dispatch:

jobs:
  build-windows-native:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install system dependencies
      run: |
        choco install -y cmake ninja
    
    - name: Setup MSYS2 with MinGW-w64
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkg-config
    
    - name: Setup vcpkg binary cache
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/.vcpkg-cache"
        echo "VCPKG_BINARY_SOURCES=clear;files,${{ github.workspace }}/.vcpkg-cache,readwrite" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          .vcpkg-cache
          vcpkg
        key: vcpkg-windows-native-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-windows-native-
    
    - name: Setup vcpkg
      shell: pwsh
      run: |
        if (-not (Test-Path "vcpkg")) {
          git clone https://github.com/Microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat -disableMetrics
        }
        echo "VCPKG_ROOT=${{ github.workspace }}/vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    
    - name: Install vcpkg dependencies
      shell: pwsh
      run: |
        cd ${{ github.workspace }}
        .\vcpkg\vcpkg.exe install --triplet x64-mingw-static --x-install-root=./vcpkg_installed
    
    - name: Configure CMake
      shell: msys2 {0}
      working-directory: src
      run: |
        export VCPKG_ROOT="${{ github.workspace }}/vcpkg"
        cmake --preset windows-cross-release
    
    - name: Build
      shell: msys2 {0}
      working-directory: src
      run: |
        cmake --build build/windows-cross-Release --parallel $(nproc)
    
    - name: Collect artifacts
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "artifacts/windows-native"
        if (Test-Path "bin") { Copy-Item -Recurse -Force bin/* artifacts/windows-native/ }
        if (Test-Path "lib") { Copy-Item -Recurse -Force lib/* artifacts/windows-native/ }
        Get-ChildItem -Recurse -Filter "*.exe" | Copy-Item -Destination artifacts/windows-native/
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ginan-windows-native-x64
        path: artifacts/windows-native/
        retention-days: 30
