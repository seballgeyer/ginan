name: Build GUI macOS (spec)

on:
  workflow_dispatch:

jobs:
  build-gui-macos:
    strategy:
      fail-fast: false
      matrix:
        arch: [arm64, x64]
    runs-on: ${{ matrix.arch == 'arm64' && 'macos-15' || 'macos-15-intel' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download macOS binaries
        uses: dawidd6/action-download-artifact@v3
        with:
          name: ginan-macos-${{ matrix.arch }}
          path: bin/
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: build-macos.yml
          workflow_conclusion: success
          if_no_artifact_found: fail

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: scripts/GinanUI/requirements.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/GinanUI/requirements.txt
          # Pin PyInstaller to a known-stable version
          pip install pyinstaller==6.10.0

      - name: Convert UI files to Python
        working-directory: scripts/GinanUI
        run: |
          pyside6-uic app/views/main_window.ui -o app/views/main_window_ui.py
          # Fix import path in generated file
          sed -i '' '23s/.*/from scripts.GinanUI.app.resources import ginan_logo_rc/' app/views/main_window_ui.py

      - name: Make binaries executable
        run: chmod +x bin/*

      - name: Create PyInstaller runtime hook for QtWebEngine
        run: |
          mkdir -p scripts/GinanUI/_pyi_hooks
          cat > scripts/GinanUI/_pyi_hooks/qtwebengine_runtime_hook.py << 'PY'
          import os, sys
          base = getattr(sys, '_MEIPASS', None)
          if base:
              qt_base = os.path.join(base, 'PySide6', 'Qt')
              res = os.path.join(qt_base, 'resources')
              os.environ.setdefault('QTWEBENGINE_RESOURCES_PATH', res)
              loc = os.path.join(res, 'qtwebengine_locales')
              os.environ.setdefault('QTWEBENGINE_LOCALES_PATH', loc)
              exe_dir = os.path.dirname(sys.executable)
              helper = os.path.join(exe_dir, 'Helpers', 'QtWebEngineProcess.app', 'Contents', 'MacOS', 'QtWebEngineProcess')
              os.environ.setdefault('QTWEBENGINEPROCESS_PATH', helper)
              # Workaround sandbox issues and reduce Chromium noise
              os.environ.setdefault('QTWEBENGINE_DISABLE_SANDBOX', '1')
              os.environ.setdefault('QTWEBENGINE_CHROMIUM_FLAGS', '--no-sandbox --disable-gpu-sandbox --disable-seccomp-filter-sandbox --disable-logging --log-level=3')
              os.environ.setdefault('QT_LOGGING_RULES', 'qt.webengine.*=false')
          PY

      - name: Build GUI with PyInstaller
        run: |
          set -e
          TARGET_ARCH=${{ matrix.arch == 'arm64' && 'arm64' || 'x86_64' }}
          python -m PyInstaller \
            --name GinanUI \
            --onedir \
            --clean \
            --noconfirm \
            --target-arch "$TARGET_ARCH" \
            --add-data "scripts/GinanUI/app:app" \
            --add-data "scripts/plot_pos.py:scripts" \
            --add-binary "bin/*:bin" \
            --collect-submodules numpy \
            --collect-submodules pandas \
            --copy-metadata numpy \
            --copy-metadata pandas \
            --collect-all scipy \
            --collect-all statsmodels \
            --copy-metadata scipy \
            --copy-metadata statsmodels \
            --collect-all PySide6.QtWebEngineCore \
            --collect-all PySide6.QtWebEngineWidgets \
            --collect-submodules PySide6 \
            --hidden-import PySide6 \
            --hidden-import PySide6.QtWebEngineWidgets \
            --hidden-import PySide6.QtWebEngineCore \
            --hidden-import scipy._cyutility \
            --hidden-import scipy.linalg._cythonized_array_utils \
            --hidden-import plotly \
            --hidden-import scripts.plot_pos \
            --hidden-import scripts.GinanUI.app \
            --hidden-import scripts.GinanUI.app.models \
            --hidden-import scripts.GinanUI.app.models.execution \
            --hidden-import scripts.GinanUI.app.controllers \
            --hidden-import scripts.GinanUI.app.controllers.input_controller \
            --hidden-import scripts.GinanUI.app.controllers.visualisation_controller \
            --hidden-import scripts.GinanUI.app.utils \
            --hidden-import scripts.GinanUI.app.utils.workers \
            --hidden-import scripts.GinanUI.app.utils.cddis_credentials \
            --hidden-import scripts.GinanUI.app.utils.cddis_email \
            --hidden-import scripts.GinanUI.app.utils.common_dirs \
            --hidden-import scripts.GinanUI.app.utils.gn_functions \
            --hidden-import scripts.GinanUI.app.utils.yaml \
            --hidden-import scripts.GinanUI.app.views.main_window_ui \
            --runtime-hook scripts/GinanUI/_pyi_hooks/qtwebengine_runtime_hook.py \
            scripts/GinanUI/main.py

      - name: Ensure QtWebEngineProcess (fallback copy if missing)
        run: |
          set -e
          if [ ! -e "dist/GinanUI/Helpers/QtWebEngineProcess.app" ]; then
            PYSIDE_PATH=$(python -c "import PySide6, os; print(os.path.dirname(PySide6.__file__))")
            mkdir -p dist/GinanUI/Helpers
            if [ -d "$PYSIDE_PATH/Qt/libexec/QtWebEngineProcess.app" ]; then
              cp -R "$PYSIDE_PATH/Qt/libexec/QtWebEngineProcess.app" dist/GinanUI/Helpers/
            elif [ -d "$PYSIDE_PATH/Qt/lib/QtWebEngineCore.framework/Helpers/QtWebEngineProcess.app" ]; then
              cp -R "$PYSIDE_PATH/Qt/lib/QtWebEngineCore.framework/Helpers/QtWebEngineProcess.app" dist/GinanUI/Helpers/
            fi
          fi

      - name: Add rpath to QtWebEngineProcess for bundled Qt
        run: |
          set -e
          HELPER=dist/GinanUI/Helpers/QtWebEngineProcess.app/Contents/MacOS/QtWebEngineProcess
          if [ -f "$HELPER" ]; then
            install_name_tool -add_rpath "@executable_path/../../../../_internal/PySide6/Qt/lib" "$HELPER" || true
          fi

      - name: Diagnostics (list bundled Qt resources)
        if: ${{ always() }}
        run: |
          echo "--- PySide6 Qt Resources in dist ---"
          ls -al dist/GinanUI/_internal/PySide6/Qt/ || true
          ls -al dist/GinanUI/_internal/PySide6/Qt/resources || true
          ls -al dist/GinanUI/_internal/PySide6/Qt/resources/qtwebengine_locales || true
          echo "--- Helpers ---"
          ls -al dist/GinanUI/Helpers/QtWebEngineProcess.app/Contents/MacOS || true

      - name: Create launcher script (run.sh)
        run: |
          cat > dist/GinanUI/run.sh << 'EOF'
          #!/usr/bin/env zsh
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          export QTWEBENGINEPROCESS_PATH="$SCRIPT_DIR/Helpers/QtWebEngineProcess.app/Contents/MacOS/QtWebEngineProcess"
          export QTWEBENGINE_RESOURCES_PATH="$SCRIPT_DIR/_internal/PySide6/Qt/resources"
          export QTWEBENGINE_LOCALES_PATH="$SCRIPT_DIR/_internal/PySide6/Qt/resources/qtwebengine_locales"
          export QTWEBENGINE_DISABLE_SANDBOX=1
          export QTWEBENGINE_CHROMIUM_FLAGS="--no-sandbox --disable-gpu-sandbox --disable-seccomp-filter-sandbox --disable-logging --log-level=3"
          export QT_LOGGING_RULES="qt.webengine.*=false"
          # Help QtWebEngineProcess resolve Qt frameworks
          export DYLD_FRAMEWORK_PATH="$SCRIPT_DIR/_internal/PySide6/Qt/lib"
          export DYLD_LIBRARY_PATH="$SCRIPT_DIR/_internal/PySide6/Qt/lib"
          if command -v xattr >/dev/null 2>&1; then
            xattr -dr com.apple.quarantine "$SCRIPT_DIR" 2>/dev/null || true
          fi
          exec "$SCRIPT_DIR/GinanUI"
          EOF
          chmod +x dist/GinanUI/run.sh

      - name: Code sign bundle (ad-hoc)
        working-directory: dist/GinanUI
        run: |
          set -e
          codesign --force --deep --sign - GinanUI || true
          find . -type f \( -name "*.so" -o -name "*.dylib" -o -name "Python" -o -name "*.pak" \) -exec codesign --force --sign - {} \; || true
          codesign --force --deep --sign - Helpers/QtWebEngineProcess.app || true

      - name: Upload GUI artifact
        uses: actions/upload-artifact@v4
        with:
          name: ginan-gui-macos2-${{ matrix.arch }}
          path: dist/GinanUI/
          retention-days: 30
